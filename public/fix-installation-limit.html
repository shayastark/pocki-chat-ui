<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>XMTP Installation Limit Fixer - Pocki Chat</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 800px;
      width: 100%;
      padding: 40px;
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }
    
    .section h2 {
      color: #333;
      font-size: 18px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    button:hover {
      background: #5568d3;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button.danger {
      background: #dc3545;
    }
    
    button.danger:hover {
      background: #c82333;
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
    }
    
    button.success {
      background: #28a745;
    }
    
    button.success:hover {
      background: #218838;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 8px;
      padding: 15px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
      line-height: 1.6;
    }
    
    .log-entry {
      margin-bottom: 8px;
    }
    
    .log-info { color: #4fc3f7; }
    .log-success { color: #4caf50; }
    .log-warning { color: #ff9800; }
    .log-error { color: #f44336; }
    
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .alert-info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    
    .alert-warning {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
    }
    
    .alert-success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    
    .steps {
      list-style: none;
      counter-reset: step-counter;
    }
    
    .steps li {
      counter-increment: step-counter;
      margin-bottom: 15px;
      padding-left: 35px;
      position: relative;
    }
    
    .steps li:before {
      content: counter(step-counter);
      position: absolute;
      left: 0;
      top: 0;
      background: #667eea;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    
    .code {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 2px 6px;
      font-family: monospace;
      font-size: 13px;
      color: #e83e8c;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ XMTP Installation Limit Fixer</h1>
    <p class="subtitle">Fix the "10/10 installations" error for Pocki Chat</p>
    
    <div class="alert alert-warning">
      <strong>âš ï¸ Problem:</strong> You've hit the XMTP installation limit (10/10). This happens when too many installations are registered on the XMTP network for your wallet.
    </div>
    
    <!-- Step 1: Diagnosis -->
    <div class="section">
      <h2>ğŸ“Š Step 1: Diagnose</h2>
      <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
        First, let's check what installation keys are stored in your browser.
      </p>
      <button onclick="diagnose()">ğŸ” Run Diagnostic</button>
      <div id="diagnosisLog" class="log" style="display: none;"></div>
    </div>
    
    <!-- Step 2: Clear Local Keys -->
    <div class="section">
      <h2>ğŸ—‘ï¸ Step 2: Clear Local Keys</h2>
      <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
        Clear all XMTP installation keys from your browser's localStorage. This won't fix the server-side limit but prepares for a fresh start.
      </p>
      <button onclick="clearLocalKeys()">ğŸ—‘ï¸ Clear All XMTP Keys</button>
      <button onclick="clearAllCache()" class="danger">ğŸ’£ Nuclear Clear (All XMTP Data)</button>
      <div id="clearLog" class="log" style="display: none;"></div>
    </div>
    
    <!-- Step 3: Solutions -->
    <div class="section">
      <h2>âœ… Step 3: Choose a Solution</h2>
      <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
        Since the 10 installations are stored server-side on XMTP, you need one of these approaches:
      </p>
      
      <div style="margin-bottom: 20px;">
        <strong style="display: block; margin-bottom: 10px;">Option A: Try with Fresh Browser (Recommended)</strong>
        <ol class="steps" style="font-size: 14px; color: #666;">
          <li>Click "Clear All XMTP Keys" above</li>
          <li>Click "Go to Pocki Chat" below</li>
          <li>Try connecting - it might work if an old installation expired</li>
        </ol>
        <button onclick="goToPockiChat()" class="success">ğŸš€ Go to Pocki Chat</button>
      </div>
      
      <div style="margin-bottom: 20px; padding-top: 20px; border-top: 2px solid #dee2e6;">
        <strong style="display: block; margin-bottom: 10px;">Option B: Contact Support</strong>
        <p style="font-size: 14px; color: #666; margin-bottom: 10px;">
          If Option A doesn't work, you need to revoke installations on the XMTP server. This requires backend access.
        </p>
        <button onclick="contactSupport()">ğŸ“§ Get Support Instructions</button>
      </div>
      
      <div style="margin-bottom: 20px; padding-top: 20px; border-top: 2px solid #dee2e6;">
        <strong style="display: block; margin-bottom: 10px;">Option C: Use Different Wallet</strong>
        <p style="font-size: 14px; color: #666; margin-bottom: 10px;">
          Each wallet gets its own installation limit. Try connecting with a different wallet address.
        </p>
        <button onclick="goToPockiChat()" class="success">ğŸš€ Go to Pocki Chat (Different Wallet)</button>
      </div>
    </div>
    
    <!-- Advanced Tools -->
    <div class="section">
      <h2>ğŸ› ï¸ Advanced Tools</h2>
      <button onclick="exportData()">ğŸ“¤ Export XMTP Data</button>
      <button onclick="showStorageKeys()">ğŸ” Show All Storage Keys</button>
      <div id="advancedLog" class="log" style="display: none;"></div>
    </div>
  </div>

  <script>
    let diagnosisLogEl, clearLogEl, advancedLogEl;
    
    function log(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      el.style.display = 'block';
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      el.appendChild(entry);
      el.scrollTop = el.scrollHeight;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    function diagnose() {
      const logId = 'diagnosisLog';
      document.getElementById(logId).innerHTML = '';
      
      log(logId, 'ğŸ” Starting diagnostic scan...', 'info');
      log(logId, 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      
      // Check for XMTP installation keys
      let xmtpKeys = [];
      let otherXmtpKeys = [];
      
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.includes('xmtp_installation_key')) {
          const value = localStorage.getItem(key);
          xmtpKeys.push({ key, value, length: value ? value.length : 0 });
        } else if (key && key.toLowerCase().includes('xmtp')) {
          otherXmtpKeys.push(key);
        }
      }
      
      log(logId, `ğŸ“Š Found ${xmtpKeys.length} installation key(s)`, xmtpKeys.length > 0 ? 'warning' : 'success');
      
      if (xmtpKeys.length > 0) {
        log(logId, 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
        log(logId, 'ğŸ”‘ Installation Keys Found:', 'warning');
        xmtpKeys.forEach((item, idx) => {
          log(logId, `  ${idx + 1}. ${item.key}`, 'warning');
          log(logId, `     Length: ${item.length} chars`, 'info');
          log(logId, `     Preview: ${item.value.substring(0, 20)}...`, 'info');
        });
      } else {
        log(logId, 'âœ… No installation keys found in localStorage', 'success');
      }
      
      if (otherXmtpKeys.length > 0) {
        log(logId, 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
        log(logId, `ğŸ“‹ Found ${otherXmtpKeys.length} other XMTP-related key(s):`, 'info');
        otherXmtpKeys.forEach((key, idx) => {
          log(logId, `  ${idx + 1}. ${key}`, 'info');
        });
      }
      
      log(logId, 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      log(logId, `ğŸ’¾ Total localStorage usage: ${localStorage.length} keys`, 'info');
      log(logId, 'âœ… Diagnostic complete!', 'success');
      
      if (xmtpKeys.length > 0) {
        log(logId, '', 'info');
        log(logId, 'âš ï¸ RECOMMENDATION: Clear these keys using Step 2 below', 'warning');
      }
    }
    
    function clearLocalKeys() {
      const logId = 'clearLog';
      document.getElementById(logId).innerHTML = '';
      
      log(logId, 'ğŸ—‘ï¸ Starting to clear XMTP installation keys...', 'info');
      
      let clearedCount = 0;
      const keysToRemove = [];
      
      // Collect keys first (can't modify during iteration)
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.includes('xmtp_installation_key')) {
          keysToRemove.push(key);
        }
      }
      
      if (keysToRemove.length === 0) {
        log(logId, 'âœ… No installation keys found to clear', 'success');
        return;
      }
      
      log(logId, `Found ${keysToRemove.length} installation key(s) to clear`, 'info');
      
      keysToRemove.forEach(key => {
        try {
          localStorage.removeItem(key);
          log(logId, `âœ… Cleared: ${key}`, 'success');
          clearedCount++;
        } catch (err) {
          log(logId, `âŒ Failed to clear: ${key} - ${err.message}`, 'error');
        }
      });
      
      log(logId, 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      log(logId, `âœ… Cleared ${clearedCount} installation key(s)`, 'success');
      log(logId, 'âœ… Local keys cleared! You can now try connecting again.', 'success');
      log(logId, '', 'info');
      log(logId, 'âš ï¸ NOTE: This only clears LOCAL data.', 'warning');
      log(logId, '   The 10 installations are still on XMTP servers.', 'warning');
      log(logId, '   Try connecting - it may work if installations expired.', 'info');
    }
    
    function clearAllCache() {
      if (!confirm('âš ï¸ This will clear ALL XMTP-related data from your browser.\n\nThis includes:\nâ€¢ Installation keys\nâ€¢ Cached messages\nâ€¢ All XMTP settings\n\nContinue?')) {
        return;
      }
      
      const logId = 'clearLog';
      document.getElementById(logId).innerHTML = '';
      
      log(logId, 'ğŸ’£ NUCLEAR CLEAR: Removing all XMTP data...', 'warning');
      
      let clearedCount = 0;
      const keysToRemove = [];
      
      // Collect all XMTP-related keys
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.toLowerCase().includes('xmtp')) {
          keysToRemove.push(key);
        }
      }
      
      log(logId, `Found ${keysToRemove.length} XMTP-related key(s)`, 'info');
      
      keysToRemove.forEach(key => {
        try {
          localStorage.removeItem(key);
          log(logId, `âœ… Removed: ${key}`, 'success');
          clearedCount++;
        } catch (err) {
          log(logId, `âŒ Failed to remove: ${key}`, 'error');
        }
      });
      
      log(logId, 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      log(logId, `âœ… Nuclear clear complete! Removed ${clearedCount} key(s)`, 'success');
      log(logId, 'ğŸš€ You can now try connecting with a fresh start', 'success');
    }
    
    function exportData() {
      const logId = 'advancedLog';
      document.getElementById(logId).innerHTML = '';
      
      log(logId, 'ğŸ“¤ Exporting XMTP data...', 'info');
      
      const data = {};
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.toLowerCase().includes('xmtp')) {
          data[key] = localStorage.getItem(key);
        }
      }
      
      const dataStr = JSON.stringify(data, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `xmtp-data-export-${Date.now()}.json`;
      link.click();
      
      log(logId, `âœ… Exported ${Object.keys(data).length} XMTP key(s)`, 'success');
      log(logId, 'ğŸ“¥ Check your downloads folder', 'info');
    }
    
    function showStorageKeys() {
      const logId = 'advancedLog';
      document.getElementById(logId).innerHTML = '';
      
      log(logId, 'ğŸ” Listing all localStorage keys...', 'info');
      log(logId, 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      
      const allKeys = [];
      for (let i = 0; i < localStorage.length; i++) {
        allKeys.push(localStorage.key(i));
      }
      
      allKeys.sort();
      
      allKeys.forEach((key, idx) => {
        const isXmtp = key.toLowerCase().includes('xmtp');
        log(logId, `${idx + 1}. ${key}`, isXmtp ? 'warning' : 'info');
      });
      
      log(logId, 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      log(logId, `Total: ${allKeys.length} keys`, 'info');
    }
    
    function goToPockiChat() {
      log('diagnosisLog', 'ğŸš€ Redirecting to Pocki Chat...', 'success');
      setTimeout(() => {
        window.location.href = '/chat';
      }, 500);
    }
    
    function contactSupport() {
      const logId = 'diagnosisLog';
      document.getElementById(logId).style.display = 'block';
      document.getElementById(logId).innerHTML = '';
      
      log(logId, 'ğŸ“§ Support Instructions', 'info');
      log(logId, 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      log(logId, '', 'info');
      log(logId, 'âš ï¸ BACKEND ACTION REQUIRED', 'warning');
      log(logId, '', 'info');
      log(logId, 'The 10/10 installation limit is stored on XMTP servers.', 'info');
      log(logId, 'To fix this, your backend agent needs to revoke installations.', 'info');
      log(logId, '', 'info');
      log(logId, 'ğŸ“‹ Backend Code to Run:', 'info');
      log(logId, '', 'info');
      log(logId, '  import { Client } from "@xmtp/browser-sdk";', 'info');
      log(logId, '  const client = await Client.create(signer, { env: "production" });', 'info');
      log(logId, '  await client.revokeAllInstallations();', 'info');
      log(logId, '', 'info');
      log(logId, 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      log(logId, 'âœ… Copy these instructions and share with your backend team', 'success');
      
      alert('Support instructions logged below. Share these with your backend team to revoke installations on the XMTP server.');
    }
    
    // Auto-run diagnosis on page load
    window.addEventListener('load', () => {
      console.log('ğŸ”§ XMTP Installation Limit Fixer loaded');
      setTimeout(diagnose, 500);
    });
  </script>
</body>
</html>
